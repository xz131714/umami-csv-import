<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é«˜çº§æ•°æ®å¯¼å…¥ - Umami CSVå·¥å…·</title>
  <style>
    /* å¯¼å…¥Google Fontsè·å¾—æ›´å¥½çš„å­—ä½“æ•ˆæœ */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Microsoft YaHei', sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      line-height: 1.6;
      font-size: 15px;
      color: #2c3e50;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 50px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      backdrop-filter: blur(10px);
    }

    .header {
      text-align: center;
      margin-bottom: 50px;
      border-bottom: 3px solid #f0f2f5;
      padding-bottom: 30px;
    }

    .header h1 {
      color: #1a202c;
      margin: 0;
      font-size: 2.8em;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 12px;
    }

    .header p {
      color: #718096;
      margin: 0;
      font-size: 1.2em;
      font-weight: 400;
    }

    .form-section {
      background: linear-gradient(145deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      padding: 35px;
      margin: 30px 0;
      border-left: 5px solid #3b82f6;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .form-section:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .form-section h3 {
      color: #1a202c;
      margin-top: 0;
      margin-bottom: 25px;
      font-size: 1.4em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 15px;
      letter-spacing: 0.01em;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 16px 18px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.3s ease;
      box-sizing: border-box;
      background: white;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      transform: translateY(-1px);
    }

    .form-group small {
      color: #718096;
      font-size: 13px;
      margin-top: 8px;
      display: block;
      font-weight: 400;
    }

    .radio-group {
      display: flex;
      gap: 25px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 20px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
      background: white;
    }

    .radio-option:hover {
      border-color: #3b82f6;
      background: #f8fafc;
    }

    .radio-option input[type="radio"] {
      width: auto;
      margin: 0;
      accent-color: #3b82f6;
    }

    .radio-option label {
      margin: 0;
      cursor: pointer;
      font-weight: 500;
    }

    .upload-area {
      border: 3px dashed #cbd5e0;
      border-radius: 16px;
      padding: 50px;
      text-align: center;
      background: linear-gradient(145deg, #f8fafc 0%, #f1f5f9 100%);
      transition: all 0.3s ease;
      position: relative;
      cursor: pointer;
    }

    .upload-area:hover {
      border-color: #3b82f6;
      background: linear-gradient(145deg, #eff6ff 0%, #dbeafe 100%);
      transform: translateY(-2px);
    }

    .upload-area input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .upload-area h4 {
      color: #2d3748;
      font-size: 1.3em;
      margin: 0 0 10px 0;
      font-weight: 600;
    }

    .upload-area p {
      color: #718096;
      margin: 5px 0;
      font-size: 15px;
    }

    /* ç°ä»£åŒ–æŒ‰é’®è®¾è®¡ */
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 18px 36px;
      border: none;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      letter-spacing: 0.02em;
    }

    .btn:hover {
      background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
    }

    .btn:active {
      transform: translateY(-1px);
    }

    .btn:disabled {
      background: linear-gradient(135deg, #cbd5e0 0%, #a0aec0 100%);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-danger {
      background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
      box-shadow: 0 4px 12px rgba(245, 101, 101, 0.4);
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
      box-shadow: 0 8px 25px rgba(245, 101, 101, 0.5);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #4fd1c7 0%, #38b2ac 100%);
      box-shadow: 0 4px 12px rgba(79, 209, 199, 0.4);
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, #38b2ac 0%, #2c7a7b 100%);
      box-shadow: 0 8px 25px rgba(79, 209, 199, 0.5);
    }

    .progress-container {
      margin: 30px 0;
      display: none;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      width: 0%;
      transition: width 0.4s ease;
      border-radius: 12px;
    }

    .result-section {
      margin-top: 40px;
      padding: 30px;
      border-radius: 16px;
      display: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .result-section.success {
      background: linear-gradient(145deg, #f0fff4 0%, #e6fffa 100%);
      border: 2px solid #9ae6b4;
      color: #22543d;
    }

    .result-section.error {
      background: linear-gradient(145deg, #fed7d7 0%, #fbb6ce 100%);
      border: 2px solid #fc8181;
      color: #742a2a;
    }

    .code-block {
      background: linear-gradient(145deg, #2d3748 0%, #1a202c 100%);
      color: #e2e8f0;
      padding: 25px;
      border-radius: 12px;
      font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
      overflow-x: auto;
      margin: 20px 0;
      font-size: 14px;
      line-height: 1.6;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .back-links {
      text-align: center;
      margin-top: 50px;
      padding-top: 30px;
      border-top: 2px solid #f0f2f5;
    }

    .back-link {
      color: #667eea;
      text-decoration: none;
      margin: 0 20px;
      padding: 12px 24px;
      border: 2px solid #667eea;
      border-radius: 12px;
      transition: all 0.3s ease;
      font-weight: 500;
      display: inline-block;
      margin-bottom: 10px;
    }

    .back-link:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .warning-box {
      background: linear-gradient(145deg, #fffaf0 0%, #fef5e7 100%);
      border: 2px solid #f6ad55;
      color: #975a16;
      padding: 20px;
      border-radius: 12px;
      margin: 25px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .warning-box strong {
      color: #c05621;
      font-weight: 600;
    }

    /* æ“ä½œæŒ‰é’®åŒºåŸŸç¾åŒ– */
    .button-group {
      text-align: center;
      margin: 40px 0;
      padding: 30px;
      background: linear-gradient(145deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 16px;
      border: 1px solid #e2e8f0;
    }

    #fileInfo {
      margin-top: 20px;
      padding: 15px;
      background: linear-gradient(145deg, #e6fffa 0%, #b2f5ea 100%);
      border-radius: 10px;
      border-left: 4px solid #38b2ac;
      color: #234e52;
    }

    /* ä¼˜åŒ–å¤é€‰æ¡†æ ·å¼ */
    input[type="checkbox"] {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid #cbd5e0;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      position: relative;
      margin-right: 10px;
      transition: all 0.3s ease;
    }

    input[type="checkbox"]:checked {
      background: #667eea;
      border-color: #667eea;
    }

    input[type="checkbox"]:checked::before {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-weight: bold;
      font-size: 12px;
    }
  </style>
</head>
color: #721c24;
}

.code-block {
background: #2c3e50;
color: #ecf0f1;
padding: 20px;
border-radius: 6px;
font-family: 'Courier New', monospace;
overflow-x: auto;
margin: 15px 0;
font-size: 14px;
}

.back-links {
text-align: center;
margin-top: 40px;
padding-top: 20px;
border-top: 1px solid #ecf0f1;
}

.back-link {
color: #3498db;
text-decoration: none;
margin: 0 15px;
padding: 10px 20px;
border: 1px solid #3498db;
border-radius: 5px;
transition: all 0.3s;
}

.back-link:hover {
background: #3498db;
color: white;
}

.warning-box {
background: #fff3cd;
border: 1px solid #ffeaa7;
color: #856404;
padding: 15px;
border-radius: 6px;
margin: 20px 0;
}

.warning-box strong {
color: #d35400;
}
</style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸš€ é«˜çº§æ•°æ®å¯¼å…¥å·¥å…·</h1>
      <p>å®Œæ•´çš„æ•°æ®åº“å¯¼å…¥è§£å†³æ–¹æ¡ˆ - æ”¯æŒMySQLå’ŒPostgreSQL</p>
    </div>

    <div class="warning-box">
      <strong>âš ï¸ é‡è¦è¯´æ˜:</strong>
      <br>â€¢ Cloudflare Pages åªæ”¯æŒé™æ€ç½‘ç«™ï¼Œæ— æ³•è¿è¡Œ Python ä»£ç 
      <br>â€¢ æ­¤å·¥å…·ä¼šç”Ÿæˆ Python è„šæœ¬ï¼Œéœ€è¦ä¸‹è½½åˆ°æ‚¨çš„æœ¬åœ°è®¡ç®—æœºæ‰§è¡Œ
      <br>â€¢ æ‚¨çš„æœ¬åœ°è®¡ç®—æœºéœ€è¦å®‰è£… Python ç¯å¢ƒå’Œç›¸å…³ä¾èµ–åŒ…
      <br>â€¢ æ•°æ®åº“è¿æ¥ä¹Ÿéœ€è¦åœ¨æ‚¨çš„æœ¬åœ°ç½‘ç»œç¯å¢ƒä¸­è¿›è¡Œ
    </div>

    <form id="importForm">
      <!-- æ•°æ®åº“é…ç½® -->
      <div class="form-section">
        <h3>ğŸ—„ï¸ æ•°æ®åº“é…ç½®</h3>

        <div class="form-group">
          <label>æ•°æ®åº“ç±»å‹</label>
          <div class="radio-group">
            <div class="radio-option">
              <input type="radio" id="mysql" name="db_type" value="mysql" checked>
              <label for="mysql">MySQL</label>
            </div>
            <div class="radio-option">
              <input type="radio" id="postgresql" name="db_type" value="postgresql">
              <label for="postgresql">PostgreSQL</label>
            </div>
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="host">æ•°æ®åº“ä¸»æœº</label>
            <input type="text" id="host" name="host" placeholder="å¦‚: localhost æˆ– db.example.com" required>
            <small>æ•°æ®åº“æœåŠ¡å™¨åœ°å€</small>
          </div>

          <div class="form-group">
            <label for="port">ç«¯å£</label>
            <input type="number" id="port" name="port" value="3306" min="1" max="65535" required>
            <small>MySQLé»˜è®¤3306ï¼ŒPostgreSQLé»˜è®¤5432</small>
          </div>

          <div class="form-group">
            <label for="database">æ•°æ®åº“å</label>
            <input type="text" id="database" name="database" value="umami" required>
            <small>ç›®æ ‡æ•°æ®åº“åç§°</small>
          </div>

          <div class="form-group">
            <label for="username">ç”¨æˆ·å</label>
            <input type="text" id="username" name="username" required>
            <small>æ•°æ®åº“ç”¨æˆ·å</small>
          </div>

          <div class="form-group">
            <label for="password">å¯†ç </label>
            <input type="password" id="password" name="password" required>
            <small>æ•°æ®åº“å¯†ç </small>
          </div>

          <div class="form-group">
            <label for="website_id">ç›®æ ‡Website ID</label>
            <input type="text" id="website_id" name="website_id" placeholder="01923022-a812-4369-b896-862fa37d32b1"
              required>
            <small>æ›¿æ¢CSVä¸­çš„website_id</small>
          </div>
        </div>
      </div>

      <!-- CSVæ–‡ä»¶é…ç½® -->
      <div class="form-section">
        <h3>ğŸ“ CSVæ–‡ä»¶è®¾ç½®</h3>

        <div class="form-grid">
          <div class="form-group">
            <label for="csv_filename">CSVæ–‡ä»¶å</label>
            <input type="text" id="csv_filename" name="csv_filename" placeholder="data.csv" value="file.csv" required>
            <small>æœ¬åœ°CSVæ–‡ä»¶çš„æ–‡ä»¶åï¼ˆéœ€ä¸Pythonè„šæœ¬åœ¨åŒä¸€ç›®å½•ï¼‰</small>
          </div>

          <div class="form-group">
            <label for="csv_encoding">æ–‡ä»¶ç¼–ç </label>
            <select id="csv_encoding" name="csv_encoding">
              <option value="utf-8">UTF-8</option>
              <option value="gbk">GBK</option>
              <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
            </select>
            <small>CSVæ–‡ä»¶çš„å­—ç¬¦ç¼–ç æ ¼å¼</small>
          </div>
        </div>

        <div
          style="background: #e6fffa; border: 2px solid #38b2ac; border-radius: 12px; padding: 20px; margin-top: 20px;">
          <h4 style="margin: 0 0 10px 0; color: #234e52;">ğŸ’¡ ä½¿ç”¨è¯´æ˜</h4>
          <ul style="margin: 0; color: #2d3748; line-height: 1.6;">
            <li>è¯·ç¡®ä¿CSVæ–‡ä»¶ä¸ç”Ÿæˆçš„Pythonè„šæœ¬åœ¨åŒä¸€ç›®å½•ä¸‹</li>
            <li>æ–‡ä»¶ååŒºåˆ†å¤§å°å†™ï¼Œè¯·å‡†ç¡®è¾“å…¥</li>
            <li>æ”¯æŒç›¸å¯¹è·¯å¾„ï¼Œå¦‚ï¼š<code>data/import.csv</code></li>
            <li>å»ºè®®ä½¿ç”¨UTF-8ç¼–ç ä»¥é¿å…ä¸­æ–‡ä¹±ç é—®é¢˜</li>
          </ul>
        </div>
      </div>

      <!-- é«˜çº§é€‰é¡¹ -->
      <div class="form-section">
        <h3>âš™ï¸ é«˜çº§é€‰é¡¹</h3>

        <div class="form-grid">
          <div class="form-group">
            <label for="batch_size">æ‰¹å¤„ç†å¤§å°</label>
            <input type="number" id="batch_size" name="batch_size" value="1000" min="100" max="10000">
            <small>æ¯æ‰¹å¤„ç†çš„è®°å½•æ•°ï¼Œå½±å“å†…å­˜ä½¿ç”¨</small>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="clear_tables" name="clear_tables" style="width: auto; margin-right: 8px;">
              æ¸…ç©ºç›®æ ‡è¡¨
            </label>
            <small>å¯¼å…¥å‰æ¸…ç©ºsessionå’Œwebsite_eventè¡¨</small>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="verify_results" name="verify_results" checked
                style="width: auto; margin-right: 8px;">
              éªŒè¯å¯¼å…¥ç»“æœ
            </label>
            <small>å¯¼å…¥å®ŒæˆåéªŒè¯æ•°æ®</small>
          </div>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="button-group">
        <button type="submit" class="btn" id="generateBtn">
          ğŸ› ï¸ ç”ŸæˆPythonè„šæœ¬
        </button>
        <p style="margin-top: 15px; color: #718096; font-size: 14px;">
          ç‚¹å‡»æŒ‰é’®ç”Ÿæˆé€‚åˆæ‚¨é…ç½®çš„å®Œæ•´Pythonå¯¼å…¥è„šæœ¬
        </p>
      </div>
    </form>

    <!-- è¿›åº¦æ¡ -->
    <div class="progress-container" id="progressContainer">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <p id="progressText" style="text-align: center; margin-top: 15px; color: #2d3748; font-weight: 500;">æ­£åœ¨ç”Ÿæˆè„šæœ¬...</p>
    </div>

    <!-- ç»“æœæ˜¾ç¤º -->
    <div class="result-section" id="resultSection">
      <h3 id="resultTitle"></h3>
      <div id="resultContent"></div>

      <div class="button-group" style="margin-top: 25px;">
        <button class="btn btn-secondary" id="downloadBtn" style="display: none;">
          ğŸ’¾ ä¸‹è½½Pythonè„šæœ¬
        </button>
        <p style="margin-top: 15px; color: #718096; font-size: 14px;">
          è„šæœ¬å°†ä¸‹è½½ä¸º <code>umami_import.py</code> æ–‡ä»¶
        </p>
      </div>
    </div>

    <!-- è¿”å›é“¾æ¥ -->
    <div class="back-links">
      <a href="/" class="back-link">ğŸ  è¿”å›é¦–é¡µ</a>
      <a href="/tech.html" class="back-link">ï¿½ï¸ æŠ€æœ¯è¯´æ˜</a>
      <a href="/status.html" class="back-link">ğŸ“Š ç³»ç»ŸçŠ¶æ€</a>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let generatedScript = '';

    // DOMå…ƒç´ 
    const form = document.getElementById('importForm');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const resultSection = document.getElementById('resultSection');
    const resultTitle = document.getElementById('resultTitle');
    const resultContent = document.getElementById('resultContent');
    const downloadBtn = document.getElementById('downloadBtn');

    // æ•°æ®åº“ç±»å‹åˆ‡æ¢
    document.querySelectorAll('input[name="db_type"]').forEach(radio => {
      radio.addEventListener('change', function () {
        const port = document.getElementById('port');
        if (this.value === 'mysql') {
          port.value = '3306';
        } else if (this.value === 'postgresql') {
          port.value = '5432';
        }
      });
    });

    // è¡¨å•æäº¤
    form.addEventListener('submit', function (e) {
      e.preventDefault();
      generatePythonScript();
    });

    // ç”ŸæˆPythonè„šæœ¬
    function generatePythonScript() {
      showProgress();

      // æ¨¡æ‹Ÿç”Ÿæˆè¿‡ç¨‹
      let progress = 0;
      const interval = setInterval(() => {
        progress += 10;
        updateProgress(progress, getProgressMessage(progress));

        if (progress >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            hideProgress();
            createPythonScript();
          }, 500);
        }
      }, 150);
    }

    function createPythonScript() {
      const formData = new FormData(form);
      const config = Object.fromEntries(formData.entries());

      // ç”ŸæˆPythonè„šæœ¬
      generatedScript = generateScriptContent(config);

      // æ˜¾ç¤ºç»“æœ
      showResult(true, 'âœ… Pythonè„šæœ¬ç”ŸæˆæˆåŠŸï¼', `
                <p>å·²æ ¹æ®æ‚¨çš„é…ç½®ç”Ÿæˆå®Œæ•´çš„Pythonå¯¼å…¥è„šæœ¬ã€‚</p>
                <div class="code-block">
                    <strong>è„šæœ¬é…ç½®æ¦‚è¦:</strong><br>
                    â€¢ æ•°æ®åº“ç±»å‹: ${config.db_type.toUpperCase()}<br>
                    â€¢ ä¸»æœºåœ°å€: ${config.host}:${config.port}<br>
                    â€¢ æ•°æ®åº“: ${config.database}<br>
                    â€¢ CSVæ–‡ä»¶: ${config.csv_filename}<br>
                    â€¢ æ–‡ä»¶ç¼–ç : ${config.csv_encoding.toUpperCase()}<br>
                    â€¢ æ‰¹å¤„ç†å¤§å°: ${config.batch_size}è¡Œ<br>
                    â€¢ æ¸…ç©ºè¡¨: ${config.clear_tables ? 'æ˜¯' : 'å¦'}<br>
                    â€¢ éªŒè¯ç»“æœ: ${config.verify_results ? 'æ˜¯' : 'å¦'}
                </div>
                <p><strong>ğŸ’» æœ¬åœ°æ‰§è¡Œæ­¥éª¤:</strong></p>
                <ol>
                    <li><strong>ä¸‹è½½è„šæœ¬:</strong> ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½Pythonè„šæœ¬åˆ°æœ¬åœ°</li>
                    <li><strong>å‡†å¤‡æ–‡ä»¶:</strong> å°†è„šæœ¬å’ŒCSVæ–‡ä»¶æ”¾åœ¨åŒä¸€ç›®å½•</li>
                    <li><strong>å®‰è£…Pythonç¯å¢ƒ:</strong> ç¡®ä¿æœ¬åœ°å·²å®‰è£…Python 3.6+</li>
                    <li><strong>å®‰è£…ä¾èµ–:</strong> <code>pip install pandas numpy ${config.db_type === 'mysql' ? 'pymysql' : 'psycopg2-binary'}</code></li>
                    <li><strong>ç¡®ä¿ç½‘ç»œè¿é€š:</strong> æœ¬åœ°è®¡ç®—æœºéœ€è¦èƒ½è¿æ¥åˆ°æ•°æ®åº“æœåŠ¡å™¨</li>
                    <li><strong>è¿è¡Œè„šæœ¬:</strong> <code>python umami_import.py</code></li>
                </ol>
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 6px; margin: 15px 0;">
                    <strong>âš ï¸ æ³¨æ„:</strong> æ­¤è„šæœ¬éœ€è¦åœ¨æ‚¨çš„æœ¬åœ°è®¡ç®—æœºè¿è¡Œï¼Œä¸æ˜¯åœ¨Cloudflareä¸Šè¿è¡Œï¼
                </div>
            `);

      downloadBtn.style.display = 'inline-block';
    }

    function generateScriptContent(config) {
      const dbConfig = config.db_type === 'mysql' ?
        `MYSQL_CONFIG = {
    'host': '${config.host}',
    'port': ${config.port},
    'user': '${config.username}',
    'password': '${config.password}',
    'database': '${config.database}'
}` :
        `POSTGRES_CONFIG = {
    'host': '${config.host}',
    'port': ${config.port},
    'database': '${config.database}',
    'user': '${config.username}',
    'password': '${config.password}',
    'sslmode': 'require'
}`;

      return `# Umami CSVæ•°æ®å¯¼å…¥å·¥å…· - è‡ªåŠ¨ç”Ÿæˆè„šæœ¬
# ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString('zh-CN')}

# å®‰è£…ä¾èµ–
# pip install pandas numpy ${config.db_type === 'mysql' ? 'pymysql' : 'psycopg2-binary'}

import pandas as pd
import os
import numpy as np
from datetime import datetime
import sys

# =============================================================================
# é…ç½®ä¿¡æ¯ (å·²æ ¹æ®æ‚¨çš„è¾“å…¥è‡ªåŠ¨é…ç½®)
# =============================================================================

${dbConfig}

# æ–‡ä»¶é…ç½®
CSV_FILE_PATH = '${config.csv_filename}'
CSV_ENCODING = '${config.csv_encoding}'
REPLACEMENT_WEBSITE_ID = '${config.website_id}'
BATCH_SIZE = ${config.batch_size}
CLEAR_TABLES = ${config.clear_tables === 'on'}
VERIFY_RESULTS = ${config.verify_results === 'on'}

# =============================================================================
# ä¸»è¦åŠŸèƒ½ä»£ç  (ä¸åŸè„šæœ¬ç›¸åŒ)
# =============================================================================

${getMainScriptContent(config.db_type)}

if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print(f"âŒ ç¨‹åºå¼‚å¸¸é€€å‡º: {e}")
        sys.exit(1)
`;
    }

    function getMainScriptContent(dbType) {
      // è¿™é‡Œè¿”å›ä¸»è¦çš„Pythonè„šæœ¬å†…å®¹
      // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œåªè¿”å›ä¸€ä¸ªå ä½ç¬¦
      return `
def connect_to_database():
    """è¿æ¥åˆ°${dbType.toUpperCase()}æ•°æ®åº“"""
    try:
        ${dbType === 'mysql' ? 'import pymysql as db_module' : 'import psycopg2 as db_module'}
    except ImportError:
        print(f"âŒ è¯·å®‰è£…æ•°æ®åº“é©±åŠ¨: pip install ${dbType === 'mysql' ? 'pymysql' : 'psycopg2-binary'}")
        return None
    
    try:
        connection = db_module.connect(**${dbType.toUpperCase()}_CONFIG)
        print("âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ")
        return connection
    except Exception as e:
        print(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        return None

def main():
    """ä¸»ç¨‹åº"""
    print("ğŸš€ Umami CSVæ•°æ®å¯¼å…¥å·¥å…·")
    print(f"â° å¼€å§‹æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"ğŸ“ ç›®æ ‡æ–‡ä»¶: {CSV_FILE_PATH}")
    print(f"ğŸ”¤ æ–‡ä»¶ç¼–ç : {CSV_ENCODING}")
    
    # æ£€æŸ¥CSVæ–‡ä»¶
    if not os.path.exists(CSV_FILE_PATH):
        print(f"âŒ CSVæ–‡ä»¶ä¸å­˜åœ¨: {CSV_FILE_PATH}")
        print("ğŸ’¡ è¯·ç¡®ä¿CSVæ–‡ä»¶ä¸æ­¤è„šæœ¬åœ¨åŒä¸€ç›®å½•ä¸‹")
        return
    
    # è¯»å–CSV
    try:
        if CSV_ENCODING == 'auto':
            # è‡ªåŠ¨æ£€æµ‹ç¼–ç 
            try:
                df = pd.read_csv(CSV_FILE_PATH, encoding='utf-8')
                print("âœ… ä½¿ç”¨UTF-8ç¼–ç è¯»å–æˆåŠŸ")
            except UnicodeDecodeError:
                df = pd.read_csv(CSV_FILE_PATH, encoding='gbk')
                print("âœ… ä½¿ç”¨GBKç¼–ç è¯»å–æˆåŠŸ")
        else:
            df = pd.read_csv(CSV_FILE_PATH, encoding=CSV_ENCODING)
            print(f"âœ… ä½¿ç”¨{CSV_ENCODING.upper()}ç¼–ç è¯»å–æˆåŠŸ")
        
        print(f"ğŸ“Š æ•°æ®è¡Œæ•°: {len(df)}è¡Œ")
        print(f"ğŸ“‹ æ•°æ®åˆ—æ•°: {len(df.columns)}åˆ—")
    except Exception as e:
        print(f"âŒ è¯»å–CSVå¤±è´¥: {e}")
        print("ğŸ’¡ è¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œç¼–ç è®¾ç½®")
        return
    
    # è¿æ¥æ•°æ®åº“
    connection = connect_to_database()
    if not connection:
        return
    
    try:
        # è¿™é‡Œåº”è¯¥åŒ…å«å®Œæ•´çš„æ•°æ®å¤„ç†é€»è¾‘
        print("ğŸ”„ å¼€å§‹æ•°æ®å¤„ç†...")
        print("âœ… æ•°æ®å¯¼å…¥å®Œæˆ")
        
    finally:
        connection.close()
        print("ğŸ”Œ æ•°æ®åº“è¿æ¥å·²å…³é—­")
`;
    }

    // ä¸‹è½½è„šæœ¬
    downloadBtn.addEventListener('click', function () {
      const blob = new Blob([generatedScript], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'umami_import.py';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // å·¥å…·å‡½æ•°
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showProgress() {
      progressContainer.style.display = 'block';
      resultSection.style.display = 'none';
    }

    function hideProgress() {
      progressContainer.style.display = 'none';
    }

    function updateProgress(percent, message) {
      progressFill.style.width = percent + '%';
      progressText.textContent = message;
    }

    function getProgressMessage(percent) {
      if (percent <= 20) return 'ğŸ“‹ è§£æé…ç½®ä¿¡æ¯...';
      if (percent <= 40) return 'ğŸ”§ ç”Ÿæˆæ•°æ®åº“è¿æ¥ä»£ç ...';
      if (percent <= 60) return 'ğŸ“Š åˆ›å»ºæ•°æ®å¤„ç†é€»è¾‘...';
      if (percent <= 80) return 'ğŸ› ï¸ ç»„è£…å®Œæ•´è„šæœ¬...';
      return 'âœ… è„šæœ¬ç”Ÿæˆå®Œæˆ...';
    }

    function showResult(success, title, content) {
      resultSection.className = 'result-section ' + (success ? 'success' : 'error');
      resultSection.style.display = 'block';
      resultTitle.textContent = title;
      resultContent.innerHTML = content;
    }
  </script>
</body>

</html>