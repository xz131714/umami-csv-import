<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Umami CSVæ•°æ®å¯¼å…¥å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
      padding: 20px;
    }

    .header {
      text-align: center;
      padding: 40px 0;
      color: white;
    }

    .header h1 {
      font-size: 3rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .header .subtitle {
      font-size: 1.3rem;
      opacity: 0.9;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
      padding: 40px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #2c3e50;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 8px;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      width: 100%;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .result {
      display: none;
      margin-top: 30px;
      padding: 20px;
      background: #d4edda;
      border: 1px solid #c3e6cb;
      border-radius: 8px;
      color: #155724;
    }

    .download-btn {
      display: none;
      background: #28a745;
      margin-top: 15px;
    }

    .download-btn:hover {
      background: #218838;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .radio-group {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>

<body>
  <div class="header">
    <h1>ğŸš€ Umami</h1>
    <p class="subtitle">CSVæ•°æ®å¯¼å…¥å·¥å…·</p>
  </div>

  <div class="container">
    <form id="configForm">
      <h2 style="margin-bottom: 30px; color: #2c3e50;">æ•°æ®åº“é…ç½®</h2>

      <div class="form-group">
        <label>æ•°æ®åº“ç±»å‹</label>
        <div class="radio-group">
          <div class="radio-option">
            <input type="radio" id="mysql" name="db_type" value="mysql" checked>
            <label for="mysql">MySQL</label>
          </div>
          <div class="radio-option">
            <input type="radio" id="postgresql" name="db_type" value="postgresql">
            <label for="postgresql">PostgreSQL</label>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="host">ä¸»æœºåœ°å€</label>
          <input type="text" id="host" name="host" placeholder="ä¾‹å¦‚: localhost æˆ– your-host.com" required>
        </div>
        <div class="form-group">
          <label for="port">ç«¯å£</label>
          <input type="number" id="port" name="port" placeholder="MySQL: 3306, PostgreSQL: 5432" required>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="username">ç”¨æˆ·å</label>
          <input type="text" id="username" name="username" placeholder="æ•°æ®åº“ç”¨æˆ·å" required>
        </div>
        <div class="form-group">
          <label for="password">å¯†ç </label>
          <input type="password" id="password" name="password" placeholder="æ•°æ®åº“å¯†ç " required>
        </div>
      </div>

      <div class="form-group">
        <label for="database">æ•°æ®åº“å</label>
        <input type="text" id="database" name="database" placeholder="ä¾‹å¦‚: umami" required>
      </div>

      <h3 style="margin: 30px 0 20px 0; color: #2c3e50;">CSVæ–‡ä»¶é…ç½®</h3>

      <div class="form-row">
        <div class="form-group">
          <label for="csv_filename">CSVæ–‡ä»¶å</label>
          <input type="text" id="csv_filename" name="csv_filename" placeholder="ä¾‹å¦‚: data.csv" required>
        </div>
        <div class="form-group">
          <label for="csv_encoding">æ–‡ä»¶ç¼–ç </label>
          <select id="csv_encoding" name="csv_encoding">
            <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
            <option value="utf-8">UTF-8</option>
            <option value="gbk">GBK</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="website_id">ç›®æ ‡Website ID</label>
        <input type="text" id="website_id" name="website_id" placeholder="ä¾‹å¦‚: 01923022-a812-4369-b896-862fa37d32b1">
        <small style="color: #666; font-size: 0.9rem;">æ‰€æœ‰å¯¼å…¥çš„æ•°æ®å°†æ›¿æ¢ä¸ºæ­¤Website IDï¼ˆå¯é€‰ï¼‰</small>
      </div>

      <div style="text-align: center; margin-top: 40px;">
        <button type="submit" class="btn">ç”ŸæˆPythonè„šæœ¬</button>
      </div>
    </form>

    <div id="result" class="result">
      <h3>âœ… è„šæœ¬ç”ŸæˆæˆåŠŸï¼</h3>
      <p>Pythonå¯¼å…¥è„šæœ¬å·²ç”Ÿæˆï¼Œç‚¹å‡»ä¸‹é¢æŒ‰é’®ä¸‹è½½ã€‚</p>
      <button id="downloadBtn" class="btn download-btn">ä¸‹è½½è„šæœ¬</button>
    </div>
  </div>

  <script>
    let generatedScript = '';

    // æ•°æ®åº“ç±»å‹åˆ‡æ¢
    document.querySelectorAll('input[name="db_type"]').forEach(radio => {
      radio.addEventListener('change', function () {
        const port = document.getElementById('port');
        // åªåœ¨ç«¯å£ä¸ºç©ºæ—¶è‡ªåŠ¨å¡«å……
        if (!port.value) {
          if (this.value === 'mysql') {
            port.placeholder = 'MySQLé»˜è®¤ç«¯å£: 3306';
          } else if (this.value === 'postgresql') {
            port.placeholder = 'PostgreSQLé»˜è®¤ç«¯å£: 5432';
          }
        }
      });
    });

    // è¡¨å•æäº¤
    document.getElementById('configForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const config = Object.fromEntries(formData.entries());

      // ç”Ÿæˆè„šæœ¬
      generatedScript = generateScript(config);

      // æ˜¾ç¤ºç»“æœ
      document.getElementById('result').style.display = 'block';
      document.getElementById('downloadBtn').style.display = 'block';
    });

    // ä¸‹è½½è„šæœ¬
    document.getElementById('downloadBtn').addEventListener('click', function () {
      const blob = new Blob([generatedScript], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'umami_import.py';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    function generateScript(config) {
      return `# å®‰è£…ä¾èµ–
# pip install pandas numpy pymysql psycopg2-binary
import pandas as pd
import os
import numpy as np
from datetime import datetime
import sys

# =============================================================================
# é…ç½®ä¿¡æ¯ - è¯·æ ¹æ®æ‚¨çš„å®é™…æƒ…å†µä¿®æ”¹
# =============================================================================

# MySQLé…ç½®
MYSQL_CONFIG = {
    'host': '${config.host}',
    'port': ${config.port},
    'user': '${config.username}',
    'password': '${config.password}',
    'database': '${config.database}'
}

# PostgreSQLé…ç½®
POSTGRES_CONFIG = {
    'host': '${config.host}',
    'port': ${config.port},
    'database': '${config.database}',
    'user': '${config.username}',
    'password': '${config.password}',
    'sslmode': 'require'
}

# æ–‡ä»¶é…ç½®
CSV_FILE_PATH = '${config.csv_filename || 'your_data.csv'}'  # CSVæ–‡ä»¶è·¯å¾„
REPLACEMENT_WEBSITE_ID = '${config.website_id || 'your-website-id-here'}'  # ç›®æ ‡website_id

# =============================================================================
# æ•°æ®åº“è¿æ¥å‡½æ•°
# =============================================================================

def connect_to_mysql():
    """è¿æ¥åˆ°MySQLæ•°æ®åº“"""
    try:
        import pymysql
    except ImportError:
        print("âŒ pymysqlæ¨¡å—æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: pip install pymysql")
        return None
    
    try:
        connection = pymysql.connect(**MYSQL_CONFIG)
        print("âœ… æˆåŠŸè¿æ¥åˆ°MySQLæ•°æ®åº“")
        
        # æµ‹è¯•è¿æ¥å¹¶æ˜¾ç¤ºä¿¡æ¯
        with connection.cursor() as cursor:
            cursor.execute("SELECT VERSION(), DATABASE(), USER()")
            version, database, user = cursor.fetchone()
            print(f"ğŸ“Š æ•°æ®åº“ç‰ˆæœ¬: {version}")
            print(f"ğŸ“‹ å½“å‰æ•°æ®åº“: {database}")
            print(f"ğŸ‘¤ å½“å‰ç”¨æˆ·: {user}")
        
        return connection
    except Exception as e:
        print(f"âŒ è¿æ¥MySQLæ•°æ®åº“å¤±è´¥: {e}")
        return None

def connect_to_postgres():
    """è¿æ¥åˆ°PostgreSQLæ•°æ®åº“"""
    try:
        import psycopg2
    except ImportError:
        print("âŒ psycopg2æ¨¡å—æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: pip install psycopg2-binary")
        return None
    
    try:
        connection = psycopg2.connect(**POSTGRES_CONFIG)
        print("âœ… æˆåŠŸè¿æ¥åˆ°PostgreSQLæ•°æ®åº“")
        
        # æµ‹è¯•è¿æ¥å¹¶æ˜¾ç¤ºä¿¡æ¯
        with connection.cursor() as cursor:
            cursor.execute("SELECT version(), current_database(), current_user")
            version, database, user = cursor.fetchone()
            print(f"ğŸ“Š æ•°æ®åº“ç‰ˆæœ¬: {version[:50]}...")
            print(f"ğŸ“‹ å½“å‰æ•°æ®åº“: {database}")
            print(f"ğŸ‘¤ å½“å‰ç”¨æˆ·: {user}")
        
        return connection
    except Exception as e:
        print(f"âŒ è¿æ¥PostgreSQLæ•°æ®åº“å¤±è´¥: {e}")
        return None

def select_database_type():
    """è®©ç”¨æˆ·é€‰æ‹©æ•°æ®åº“ç±»å‹"""
    print("\\n" + "="*50)
    print("ğŸ”— è¯·é€‰æ‹©è¦ä½¿ç”¨çš„æ•°æ®åº“ç±»å‹:")
    print("1. MySQL")
    print("2. PostgreSQL")
    print("="*50)
    
    while True:
        choice = input("è¯·è¾“å…¥é€‰æ‹© (1 æˆ– 2): ").strip()
        
        if choice == '1':
            print("ğŸ”¹ å·²é€‰æ‹©: MySQL")
            return 'mysql'
        elif choice == '2':
            print("ğŸ”¹ å·²é€‰æ‹©: PostgreSQL")
            return 'postgres'
        else:
            print("âŒ æ— æ•ˆé€‰æ‹©ï¼Œè¯·è¾“å…¥ 1 æˆ– 2")

def connect_to_database(db_type):
    """æ ¹æ®æ•°æ®åº“ç±»å‹è¿æ¥åˆ°ç›¸åº”æ•°æ®åº“"""
    print(f"\\nğŸ”Œ æ­£åœ¨è¿æ¥åˆ° {db_type.upper()} æ•°æ®åº“...")
    
    if db_type == 'mysql':
        return connect_to_mysql()
    elif db_type == 'postgres':
        return connect_to_postgres()
    else:
        print(f"âŒ ä¸æ”¯æŒçš„æ•°æ®åº“ç±»å‹: {db_type}")
        return None

# =============================================================================
# æ•°æ®å¤„ç†å‡½æ•°
# =============================================================================

def clean_dataframe_for_db(df):
    """æ¸…ç†DataFrameæ•°æ®ï¼Œç¡®ä¿æ•°æ®åº“å…¼å®¹æ€§"""
    print(f"ğŸ§¹ å¼€å§‹æ¸…æ´—æ•°æ®ï¼ŒåŸå§‹è¡Œæ•°: {len(df)}")
    
    # åˆ›å»ºå‰¯æœ¬
    cleaned_df = df.copy()
    
    # å¤„ç†ç‰¹æ®Šå€¼
    cleaned_df = cleaned_df.replace([np.nan, np.inf, -np.inf], None)
    
    # ç®€å•ç»Ÿè®¡
    null_count = cleaned_df.isnull().sum().sum()
    
    print(f"âœ… æ•°æ®æ¸…æ´—å®Œæˆ:")
    print(f"   - æ•°æ®å½¢çŠ¶: {cleaned_df.shape}")
    print(f"   - ç©ºå€¼æ•°é‡: {null_count}")
    
    return cleaned_df

def get_table_columns(connection, table_name, db_type):
    """è·å–æ•°æ®åº“è¡¨çš„åˆ—å"""
    with connection.cursor() as cursor:
        if db_type == 'mysql':
            cursor.execute(f"DESCRIBE \`{table_name}\`")
            columns = [column[0] for column in cursor.fetchall()]
        else:  # postgres
            cursor.execute(f"""
                SELECT column_name 
                FROM information_schema.columns 
                WHERE table_name='{table_name}' 
                ORDER BY ordinal_position
            """)
            columns = [column[0] for column in cursor.fetchall()]
    return columns

def truncate_tables(connection, db_type):
    """æ¸…ç©ºç›®æ ‡è¡¨"""
    print("ğŸ—‘ï¸ æ­£åœ¨æ¸…ç©ºç›®æ ‡è¡¨...")
    target_tables = ['session', 'website_event']
    
    with connection.cursor() as cursor:
        try:
            for table in target_tables:
                if db_type == 'mysql':
                    cursor.execute(f"TRUNCATE TABLE \`{table}\`")
                else:  # postgres
                    cursor.execute(f'TRUNCATE TABLE "{table}" RESTART IDENTITY CASCADE')
                print(f"   âœ… å·²æ¸…ç©ºè¡¨: {table}")
            
            connection.commit()
            print("âœ… æ‰€æœ‰è¡¨æ¸…ç©ºå®Œæˆ")
            
        except Exception as e:
            print(f"âŒ æ¸…ç©ºè¡¨æ—¶å‡ºé”™: {e}")
            connection.rollback()

def insert_data_batch(connection, table_name, df, db_type, batch_size=1000):
    """æ‰¹é‡æ’å…¥æ•°æ®ï¼Œæ”¯æŒMySQLå’ŒPostgreSQL"""
    if df.empty:
        print(f"âš ï¸ è¡¨{table_name}æ²¡æœ‰æ•°æ®éœ€è¦æ’å…¥")
        return
    
    print(f"ğŸ“¥ å¼€å§‹æ’å…¥è¡¨ {table_name}ï¼Œæ•°æ®è¡Œæ•°: {len(df)}")
    
    # æ„å»ºSQLè¯­å¥
    columns = list(df.columns)
    
    if db_type == 'mysql':
        # MySQLè¯­æ³•
        column_names = ', '.join([f"\`{col}\`" for col in columns])
        placeholders = ', '.join(['%s'] * len(columns))
        sql = f"INSERT IGNORE INTO \`{table_name}\` ({column_names}) VALUES ({placeholders})"
    else:  # postgres
        # PostgreSQLè¯­æ³•
        column_names = ', '.join([f'"{col}"' for col in columns])
        placeholders = ', '.join(['%s'] * len(columns))
        sql = f'INSERT INTO "{table_name}" ({column_names}) VALUES ({placeholders}) ON CONFLICT DO NOTHING'
    
    # è½¬æ¢æ•°æ®
    data_tuples = []
    for _, row in df.iterrows():
        tuple_row = tuple(None if pd.isna(val) else val for val in row.values)
        data_tuples.append(tuple_row)
    
    # åˆ†æ‰¹æ’å…¥
    inserted_count = 0
    total_processed = 0
    
    with connection.cursor() as cursor:
        try:
            for i in range(0, len(data_tuples), batch_size):
                batch = data_tuples[i:i + batch_size]
                
                # è·å–æ’å…¥å‰çš„è¡Œæ•°
                if db_type == 'mysql':
                    cursor.execute(f"SELECT COUNT(*) FROM \`{table_name}\`")
                else:
                    cursor.execute(f'SELECT COUNT(*) FROM "{table_name}"')
                count_before = cursor.fetchone()[0]
                
                # æ‰§è¡Œæ‰¹é‡æ’å…¥
                cursor.executemany(sql, batch)
                connection.commit()
                
                # è·å–æ’å…¥åçš„è¡Œæ•°
                if db_type == 'mysql':
                    cursor.execute(f"SELECT COUNT(*) FROM \`{table_name}\`")
                else:
                    cursor.execute(f'SELECT COUNT(*) FROM "{table_name}"')
                count_after = cursor.fetchone()[0]
                
                # ç»Ÿè®¡ç»“æœ
                batch_inserted = count_after - count_before
                batch_skipped = len(batch) - batch_inserted
                
                inserted_count += batch_inserted
                total_processed += len(batch)
                
                print(f"   æ‰¹æ¬¡{i//batch_size + 1}: å¤„ç†{len(batch)}è¡Œï¼Œæ’å…¥{batch_inserted}è¡Œï¼Œè·³è¿‡{batch_skipped}è¡Œ")
        
        except Exception as e:
            print(f"âŒ æ’å…¥æ•°æ®åˆ°è¡¨{table_name}æ—¶å‡ºé”™: {e}")
            connection.rollback()
            return
    
    skipped_count = total_processed - inserted_count
    print(f"âœ… è¡¨{table_name}æ’å…¥å®Œæˆ: æ€»å…±å¤„ç†{total_processed}è¡Œï¼Œæ’å…¥{inserted_count}è¡Œï¼Œè·³è¿‡{skipped_count}è¡Œé‡å¤æ•°æ®")
    if total_processed > 0:
        print(f"ğŸ“ˆ å»é‡ç‡: {skipped_count/total_processed*100:.1f}%")

def process_table(connection, csv_df, table_name, db_type):
    """å¤„ç†å•ä¸ªè¡¨çš„æ•°æ®å¯¼å…¥"""
    print(f"\\nğŸ”„ å¤„ç†è¡¨: {table_name}")
    
    # è·å–æ•°æ®åº“è¡¨ç»“æ„
    table_columns = get_table_columns(connection, table_name, db_type)
    print(f"ğŸ“‹ æ•°æ®åº“è¡¨ {table_name} åŒ…å« {len(table_columns)} ä¸ªå­—æ®µ")
    
    # åŒ¹é…CSVå’Œæ•°æ®åº“å…±æœ‰å­—æ®µ
    common_columns = [col for col in table_columns if col in csv_df.columns]
    
    if not common_columns:
        print(f"âš ï¸ è¡¨{table_name}æ²¡æœ‰ä¸CSVæ–‡ä»¶åŒ¹é…çš„åˆ—")
        return
    
    print(f"ğŸ¯ åŒ¹é…åˆ° {len(common_columns)} ä¸ªå…±åŒå­—æ®µ: {common_columns[:5]}{'...' if len(common_columns) > 5 else ''}")
    
    # åˆ›å»ºå­æ•°æ®é›†
    sub_df = csv_df[common_columns].copy()
    
    # æ›¿æ¢website_id
    if 'website_id' in sub_df.columns:
        sub_df['website_id'] = REPLACEMENT_WEBSITE_ID
        print(f"ğŸ”„ å·²æ›¿æ¢website_idä¸º: {REPLACEMENT_WEBSITE_ID[:8]}...")
    
    # æ¸…æ´—å¹¶æ’å…¥æ•°æ®
    cleaned_df = clean_dataframe_for_db(sub_df)
    insert_data_batch(connection, table_name, cleaned_df, db_type)

# =============================================================================
# ä¸»ç¨‹åº
# =============================================================================

def main():
    """ä¸»ç¨‹åºå…¥å£"""
    print("ğŸš€ Umami CSVæ•°æ®é€šç”¨å¯¼å…¥å·¥å…·")
    print(f"â° å¼€å§‹æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 60)
    
    # æ£€æŸ¥CSVæ–‡ä»¶
    if not os.path.exists(CSV_FILE_PATH):
        print(f"âŒ CSVæ–‡ä»¶ä¸å­˜åœ¨: {CSV_FILE_PATH}")
        return
    
    # è¯»å–CSVæ–‡ä»¶
    try:
        print(f"ğŸ“– æ­£åœ¨è¯»å–CSVæ–‡ä»¶: {CSV_FILE_PATH}")
        ${config.csv_encoding === 'auto' ?
          `# è‡ªåŠ¨æ£€æµ‹ç¼–ç 
        try:
            df = pd.read_csv(CSV_FILE_PATH, encoding='utf-8')
            print("âœ… ä½¿ç”¨UTF-8ç¼–ç è¯»å–æˆåŠŸ")
        except UnicodeDecodeError:
            df = pd.read_csv(CSV_FILE_PATH, encoding='gbk')
            print("âœ… ä½¿ç”¨GBKç¼–ç è¯»å–æˆåŠŸ")` :
          `df = pd.read_csv(CSV_FILE_PATH, encoding='${config.csv_encoding}')
        print("âœ… ä½¿ç”¨${config.csv_encoding.toUpperCase()}ç¼–ç è¯»å–æˆåŠŸ")`
        }
        print(f"âœ… CSVæ–‡ä»¶è¯»å–æˆåŠŸï¼Œå…±{len(df)}è¡Œæ•°æ®ï¼Œ{len(df.columns)}ä¸ªå­—æ®µ")
        print(f"ğŸ“Š å­—æ®µåˆ—è¡¨: {list(df.columns)[:8]}{'...' if len(df.columns) > 8 else ''}")
    except Exception as e:
        print(f"âŒ è¯»å–CSVæ–‡ä»¶å¤±è´¥: {e}")
        return
    
    # é€‰æ‹©æ•°æ®åº“ç±»å‹
    db_type = select_database_type()
    
    # è¿æ¥æ•°æ®åº“
    connection = connect_to_database(db_type)
    if not connection:
        return
    
    try:
        # æ£€æŸ¥ç›®æ ‡è¡¨æ˜¯å¦å­˜åœ¨
        print(f"\\nğŸ” æ£€æŸ¥ç›®æ ‡è¡¨:")
        target_tables = ['session', 'website_event']
        
        for table in target_tables:
            try:
                table_columns = get_table_columns(connection, table, db_type)
                print(f"   âœ… è¡¨ {table}: {len(table_columns)} ä¸ªå­—æ®µ")
            except Exception as e:
                print(f"   âŒ è¡¨ {table}: ä¸å­˜åœ¨æˆ–æ— æƒé™")
        
        # è¯¢é—®æ˜¯å¦æ¸…ç©ºè¡¨
        clear_choice = input(f"\\nğŸ—‘ï¸ æ˜¯å¦æ¸…ç©ºç›®æ ‡è¡¨? (y/N): ").strip().lower()
        if clear_choice in ['y', 'yes']:
            truncate_tables(connection, db_type)
        
        # å¤„ç†ç›®æ ‡è¡¨
        for table in target_tables:
            try:
                process_table(connection, df, table, db_type)
            except Exception as e:
                print(f"âŒ å¤„ç†è¡¨{table}æ—¶å‡ºé”™: {e}")
                continue
        
        print("\\n" + "=" * 60)
        print(f"ğŸ‰ æ•°æ®å¯¼å…¥å®Œæˆï¼")
        print(f"â° ç»“æŸæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        
        # éªŒè¯å¯¼å…¥ç»“æœ
        verify_results = input(f"\\nğŸ” æ˜¯å¦éªŒè¯å¯¼å…¥ç»“æœ? (Y/n): ").strip().lower()
        if verify_results not in ['n', 'no']:
            verify_import_results(connection, db_type)
        
    except KeyboardInterrupt:
        print(f"\\nâš ï¸ ç”¨æˆ·ä¸­æ–­æ“ä½œ")
    except Exception as e:
        print(f"âŒ ç¨‹åºæ‰§è¡Œå‡ºé”™: {e}")
    finally:
        connection.close()
        print("ğŸ”Œ æ•°æ®åº“è¿æ¥å·²å…³é—­")

def verify_import_results(connection, db_type):
    """éªŒè¯æ•°æ®å¯¼å…¥ç»“æœ"""
    print("\\nğŸ” éªŒè¯æ•°æ®å¯¼å…¥ç»“æœ")
    print("=" * 40)
    
    try:
        with connection.cursor() as cursor:
            # æŸ¥è¯¢å„è¡¨çš„æ•°æ®é‡
            tables = ['session', 'website_event']
            
            for table in tables:
                if db_type == 'mysql':
                    cursor.execute(f"SELECT COUNT(*) FROM \`{table}\`")
                else:
                    cursor.execute(f'SELECT COUNT(*) FROM "{table}"')
                
                count = cursor.fetchone()[0]
                print(f"ğŸ“Š è¡¨ {table}: {count} æ¡è®°å½•")
            
            # ç»Ÿè®¡website_id
            if db_type == 'mysql':
                cursor.execute("SELECT website_id, COUNT(*) FROM \`session\` GROUP BY website_id")
            else:
                cursor.execute('SELECT website_id, COUNT(*) FROM "session" GROUP BY website_id')
            
            website_stats = cursor.fetchall()
            if website_stats:
                print("\\nğŸ¯ Website ID ç»Ÿè®¡:")
                for website_id, count in website_stats:
                    print(f"   {website_id}: {count} ä¸ªä¼šè¯")
    
    except Exception as e:
        print(f"âŒ éªŒè¯è¿‡ç¨‹å‡ºé”™: {e}")
    
    print("\\nâœ… éªŒè¯å®Œæˆ")

if __name__ == "__main__":
    try:
        main()
    except Exception as e:
        print(f"âŒ ç¨‹åºå¼‚å¸¸é€€å‡º: {e}")
        sys.exit(1)
`;
    }
  </script>
</body>

</html>